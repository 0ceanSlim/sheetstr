<!DOCTYPE html>
<html data-theme="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Primary Meta Tags -->
  <title>Nostr SpreadSheets</title>
  <meta name="title" content="Nostr Spreadsheets" />
  <meta name="description" content="Fetch, backup and broadcast your Nostr events" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="img/icon.png" type="image/x-icon" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Lightning -->
  <meta name="lightning" content="vitor@vitorpamplona.com" />
  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="img/icon.png" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Nostr Spreadsheets">
  <meta property="og:description" content="The first Nostr-native spreadsheet">
  <meta property="og:image" content="https://sheetstr.amethyst.social/img/sheetstr-card-wide.jpg">
  <!-- Replace with the URL of your larger image -->
  <meta property="og:url" content="https://sheetstr.amethyst.social">

  <link rel="stylesheet" href="https://unpkg.com/@univerjs/design/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/docs-ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-formula/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-numfmt/lib/index.css" />

  <script src="https://unpkg.com/clsx/dist/clsx.min.js"></script>
  <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/rxjs/dist/bundles/rxjs.umd.min.js"></script>
  <script src="https://unpkg.com/@wendellhu/redi/dist/redi.js"></script>
  <script src="https://unpkg.com/@wendellhu/redi/dist/react-bindings.js"></script>

  <script src="https://unpkg.com/@univerjs/protocol/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/core/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/design/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-render/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-numfmt/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-formula/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/docs/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/docs-ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-formula/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-numfmt/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/network/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/facade/lib/umd/index.js"></script>
</head>

<body>
  <script src="js/jquery-3.6.2.min.js"></script>
  <script src="js/promise-pool.js"></script>
  <script src="js/nostr-sign.js"></script>
  <script src="js/nostr-filter.js"></script>
  <script src="js/nostr-relay.js"></script>
  <script src="js/relays.js"></script>
  <script src="js/sheetstr.js"></script>

  <div id="app"></div>

  <script>
    var {
      UniverCore,
      UniverDesign,
      UniverEngineRender,
      UniverEngineFormula,
      UniverDocs,
      UniverDocsUi,
      UniverUi,
      UniverSheets,
      UniverSheetsUi,
      UniverSheetsNumfmt,
      UniverSheetsFormula,
      UniverFacade,
    } = window

    var univer = new UniverCore.Univer({
      theme: UniverDesign.defaultTheme,
      locale: UniverCore.LocaleType.EN_US,
      locales: {
        [UniverCore.LocaleType.EN_US]: {
          ...UniverSheets.enUS,
          ...UniverDocsUi.enUS,
          ...UniverSheetsUi.enUS,
          ...UniverUi.enUS,
          ...UniverDesign.enUS,
        },
      },
    });

    univer.registerPlugin(UniverEngineRender.UniverRenderEnginePlugin);
    univer.registerPlugin(UniverEngineFormula.UniverFormulaEnginePlugin);

    univer.registerPlugin(UniverUi.UniverUIPlugin, {
      container: "app",
      header: true,
      footer: true,
    });

    univer.registerPlugin(UniverDocs.UniverDocsPlugin, {
      hasScroll: false,
    });
    univer.registerPlugin(UniverDocsUi.UniverDocsUIPlugin);

    univer.registerPlugin(UniverSheets.UniverSheetsPlugin);
    univer.registerPlugin(UniverSheetsUi.UniverSheetsUIPlugin);
    univer.registerPlugin(UniverSheetsNumfmt.UniverSheetsNumfmtPlugin);
    univer.registerPlugin(UniverSheetsFormula.UniverSheetsFormulaPlugin);    

    const univerAPI = UniverFacade.FUniver.newAPI(univer)

    univerAPI.onCommandExecuted((command, options) => {
      // Only synchronize local mutations
      if (command.type !== 2 || options?.fromCollab || options?.onlyLocal || command.id === 'doc.mutation.rich-text-editing' || command.id === 'sheet.mutation.set-worksheet-row-auto-height') {
        return;
      }
      
      const activeWorkbook = univerAPI.getActiveWorkbook()
      const saveData = activeWorkbook.getSnapshot();

      console.log("Saving1", saveData)
      data = []

      for (sheetName of saveData.sheetOrder) {
        console.log(sheetName);

        let sheet = saveData.sheets[sheetName]

        try { 
          for (rowNumber of Object.keys(sheet.cellData)) {
            let row = sheet.cellData[rowNumber]
            for (colNumber of Object.keys(row)) {
              let col = row[colNumber]
              if (col.f)
                data.push([sheet.name, UniverCore.numberToABC(colNumber), (parseInt(rowNumber)+1).toString(), col.f]);
              else
                data.push([sheet.name, UniverCore.numberToABC(colNumber), (parseInt(rowNumber)+1).toString(), col.v.toString()]);
            }
          }
        } catch (e) {
          console.log(e)
        }
      }

      console.log("Saving2", data)

      try { 
        saveSpreadSheet(data)
      } catch (e) {
        console.log(e)
      }
    })

    fetchSpreadSheet((data) => { 
      console.log("Load from", data)

      let workbook = {
        id: UniverCore.Tools.generateRandomId(6),
        locale: UniverCore.LocaleType.EN_US,
        appVersion: "0.1.7",
        name: '',
        sheetOrder: [],
        sheets: {},
        styles: {},
        resources: [],
      }
      for (rowColData of data) {
        let sheetName = rowColData[0]
        if (!workbook.sheetOrder.includes(sheetName)) {
          workbook.sheetOrder.push(sheetName)
        }

        let row = parseInt(rowColData[2])-1
        let col = UniverCore.ABCToNumber(rowColData[1])

        let type = 1
        let formula = undefined
        let value = undefined
        if (rowColData[3][0] == "=") {
          formula = rowColData[3]
        } else {
          let valueClass = Number(rowColData[3]);
          if (!isNaN(valueClass)) {
            value = parseFloat(rowColData[3])
            type = 2
          } else {
            value = rowColData[3]
          }
        }

        if (!workbook.sheets[sheetName]) {
          workbook.sheets[sheetName] = {
            id: sheetName,
            cellData: {},
            rowData: {}
          }
        }

        if (!workbook.sheets[sheetName].cellData[row]) {
          workbook.sheets[sheetName].cellData[row] = {}
        }

        if (!workbook.sheets[sheetName].cellData[row][col]) {
          workbook.sheets[sheetName].cellData[row][col] = {}
        }

        workbook.sheets[sheetName].cellData[row][col] = {
          t: type,
          v: value, 
          f: formula, 
        }
      }      

      console.log("Openning", workbook)

      univer.createUniverSheet(workbook);
    }, )
  </script>
</body>
</body>

</html>