<!DOCTYPE html>
<html data-theme="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Primary Meta Tags -->
  <title>Nostr SpreadSheets</title>
  <meta name="title" content="Nostr Spreadsheets" />
  <meta name="description" content="The first Nostr-native spreadsheet" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="img/icon.png" type="image/x-icon" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Lightning -->
  <meta name="lightning" content="vitor@vitorpamplona.com" />
  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="img/icon.png" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Nostr Spreadsheets">
  <meta property="og:description" content="The first Nostr-native spreadsheet">
  <meta property="og:image" content="https://sheetstr.amethyst.social/img/sheetstr-card-wide.png">
  <!-- Replace with the URL of your larger image -->
  <meta property="og:url" content="https://sheetstr.amethyst.social">

  <link rel="stylesheet" href="https://unpkg.com/@univerjs/design/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/docs-ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-ui/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-formula/lib/index.css" />
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/sheets-numfmt/lib/index.css" />

  <script src="https://unpkg.com/clsx/dist/clsx.min.js"></script>
  <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/rxjs/dist/bundles/rxjs.umd.min.js"></script>
  <script src="https://unpkg.com/@wendellhu/redi/dist/redi.js"></script>
  <script src="https://unpkg.com/@wendellhu/redi/dist/react-bindings.js"></script>

  <script src="https://unpkg.com/@univerjs/protocol/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/core/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/design/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-render/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-numfmt/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/engine-formula/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/docs/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/docs-ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-ui/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-formula/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/sheets-numfmt/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/network/lib/umd/index.js"></script>
  <script src="https://unpkg.com/@univerjs/facade/lib/umd/index.js"></script>
  <script src="https://www.unpkg.com/nostr-login@1.1.1/dist/unpkg.js"></script> 
</head>

<body>
  <script src="js/jquery-3.6.2.min.js"></script>
  <script src="js/nostr-sign.js"></script>
  <script src="js/nostr-filter.js"></script>
  <script src="js/sheetstr.js"></script>
  <script src="js/univer-utils.js"></script>

  <div id="app"></div>

  <script>
    var {
      UniverCore,
      UniverDesign,
      UniverEngineRender,
      UniverEngineFormula,
      UniverDocs,
      UniverDocsUi,
      UniverUi,
      UniverSheets,
      UniverSheetsUi,
      UniverSheetsNumfmt,
      UniverSheetsFormula,
      UniverFacade,
    } = window

    var univer = new UniverCore.Univer({
      theme: UniverDesign.defaultTheme,
      locale: UniverCore.LocaleType.EN_US,
      locales: {
        [UniverCore.LocaleType.EN_US]: {
          ...UniverSheets.enUS,
          ...UniverDocsUi.enUS,
          ...UniverSheetsUi.enUS,
          ...UniverUi.enUS,
          ...UniverDesign.enUS,
        },
      },
    });

    univer.registerPlugin(UniverEngineRender.UniverRenderEnginePlugin);
    univer.registerPlugin(UniverEngineFormula.UniverFormulaEnginePlugin);

    univer.registerPlugin(UniverUi.UniverUIPlugin, {
      container: "app",
      header: true,
      footer: true,
    });

    univer.registerPlugin(UniverDocs.UniverDocsPlugin, {
      hasScroll: false,
    });
    univer.registerPlugin(UniverDocsUi.UniverDocsUIPlugin);

    univer.registerPlugin(UniverSheets.UniverSheetsPlugin);
    univer.registerPlugin(UniverSheetsUi.UniverSheetsUIPlugin);
    univer.registerPlugin(UniverSheetsNumfmt.UniverSheetsNumfmtPlugin);
    univer.registerPlugin(UniverSheetsFormula.UniverSheetsFormulaPlugin);    

    const univerAPI = UniverFacade.FUniver.newAPI(univer)

    univerAPI.onCommandExecuted((command, options) => {
      // Only synchronize local mutations
      if (command.type !== 2 || options?.fromCollab || options?.onlyLocal || command.id === 'doc.mutation.rich-text-editing' || command.id === 'sheet.mutation.set-worksheet-row-auto-height') {
        return;
      }
      
      const activeWorkbook = univerAPI.getActiveWorkbook()
      const saveData = activeWorkbook.getSnapshot();

      try { 
        const data = convertUniverToDataArray(saveData)
        saveSpreadSheet(data)
      } catch (e) {
        console.log(e)
      }
    })

    fetchSpreadSheet((data) => { 
      univer.createUniverSheet(convertDataArrayToUniver(data));
    }, )
  </script>
</body>
</body>

</html>