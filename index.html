<!DOCTYPE html>
<html data-theme="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Primary Meta Tags -->
  <title>Nostr SpreadSheets</title>
  <meta name="title" content="Nostr Spreadsheets" />
  <meta name="description" content="The first Nostr-native spreadsheet" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="img/icon.png" type="image/x-icon" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Lightning -->
  <meta name="lightning" content="vitor@vitorpamplona.com" />
  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="img/icon.png" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Nostr Spreadsheets">
  <meta property="og:description" content="The first Nostr-native spreadsheet">
  <meta property="og:image" content="https://sheetstr.amethyst.social/img/sheetstr-card-wide.png">
  <!-- Replace with the URL of your larger image -->
  <meta property="og:url" content="https://sheetstr.amethyst.social">

  <script src="https://unpkg.com/@univerjs/umd/lib/univer.full.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/umd/lib/univer.css">

  <script src="js/jquery-3.6.2.min.js"></script>
  <script src="js/nostr-sign.js"></script>
  <script src="js/nostr-filter.js"></script>
  <script src="js/sheetstr.js"></script>
  <script src="js/univer-utils.js"></script>

  <script src="https://www.unpkg.com/nostr-login@latest/dist/unpkg.js" data-perms="sign_event:35337,nip44_encrypt,nip44_decrypt"></script> 
</head>

<body>
  <div id="dashboard">
    <header id="header">
      <h1>Your Spreadsheets</h1>
    </header>
    <table class="styled-table">
      <thead>
          <tr>
              <th>Name</th>
              <th class="right">Last Modified</th>
          </tr>
      </thead>
      <tbody id="sheets">
          
      </tbody>
    </table>

    <input type="text" class="cool-field" id="newDTag" name="newDTag" value="" placeholder="My cool new sheet">
    <button id="fetch-and-broadcast" onclick="document.location.href='?id=' + $('#newDTag').val(); return false;">
      Create
    </button>
  </div>
  <div id="app"></div>

  <script>
    var univer = undefined

    $(document).ready(function() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      const dTag = urlParams.get('id')

      console.log("onLoad", dTag)
      
      if (dTag) {
        hideDashboard()
        loadId(dTag)
      } else {
        showDashboard()
        loadDashboard()
      }
    });

    async function hideDashboard() {
      $("#dashboard").hide();
      $("#app").show();
    }
    
    async function showDashboard() {
      $("#app").hide();
      $("#dashboard").show();
    }

    async function loadDashboard() {
      $("#sheets").html("");
      fetchAllSpreadsheets((dTag) => { 
        console.log("found", dTag)
        $("#sheets").append("<tr onclick=\"document.location.href='?id="+dTag+"'\"><td>"+dTag+"</td><td class=\"right\">6000</td></tr>")
      })
    }

    async function loadId(dTag) {
      try {
        let dummy = await window.nostr.getPublicKey()
      } catch (e) {

      }

      fetchSpreadSheet(dTag, (name, data) => { 
        var {
          UniverCore,
          UniverDesign,
          UniverEngineRender,
          UniverEngineFormula,
          UniverDocs,
          UniverDocsUi,
          UniverUi,
          UniverSheets,
          UniverSheetsUi,
          UniverSheetsNumfmt,
          UniverSheetsFormula,
          UniverFacade,
        } = window

        if (univer) {
          univer.dispose()
          univer = undefined
        }

        univer = new UniverCore.Univer({
          theme: UniverDesign.defaultTheme,
          locale: UniverCore.LocaleType.EN_US,
          locales: {
            [UniverCore.LocaleType.EN_US]: {
              ...UniverSheets.enUS,
              ...UniverDocsUi.enUS,
              ...UniverSheetsUi.enUS,
              ...UniverUi.enUS,
              ...UniverDesign.enUS,
            },
          },
        });

        univer.registerPlugin(UniverEngineRender.UniverRenderEnginePlugin);
        univer.registerPlugin(UniverEngineFormula.UniverFormulaEnginePlugin);

        univer.registerPlugin(UniverUi.UniverUIPlugin, {
          container: "app",
          header: true,
          footer: true,
        });

        univer.registerPlugin(UniverDocs.UniverDocsPlugin, {
          hasScroll: false,
        });
        univer.registerPlugin(UniverDocsUi.UniverDocsUIPlugin);

        univer.registerPlugin(UniverSheets.UniverSheetsPlugin);
        univer.registerPlugin(UniverSheetsUi.UniverSheetsUIPlugin);
        univer.registerPlugin(UniverSheetsNumfmt.UniverSheetsNumfmtPlugin);
        univer.registerPlugin(UniverSheetsFormula.UniverSheetsFormulaPlugin);    

        const univerAPI = UniverFacade.FUniver.newAPI(univer)

        univerAPI.onCommandExecuted((command, options) => {
          // Only synchronize local mutations
          if (command.type !== 2 || options?.fromCollab || options?.onlyLocal || command.id === 'doc.mutation.rich-text-editing' || command.id === 'sheet.mutation.set-worksheet-row-auto-height') {
            return;
          }
          
          const activeWorkbook = univerAPI.getActiveWorkbook()
          const saveData = activeWorkbook.getSnapshot();

          try { 
            const data = convertUniverToDataArray(saveData)
            saveSpreadSheet(dTag, data)
          } catch (e) {
            console.log(e)
          }
        })

        univer.createUniverSheet(convertDataArrayToUniver(name, data));
      }, )
    }
  </script>
</body>
</body>

</html>