<!DOCTYPE html>
<html data-theme="light" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Primary Meta Tags -->
  <title>Nostr SpreadSheets</title>
  <meta name="title" content="Nostr Spreadsheets" />
  <meta name="description" content="The first Nostr-native spreadsheet" />

  <!-- Favicon -->
  <link rel="shortcut icon" href="img/icon.png" type="image/x-icon" />
  <!-- CSS -->
  <link rel="stylesheet" href="style.css" />
  <!-- Lightning -->
  <meta name="lightning" content="vitor@vitorpamplona.com" />
  <!-- PWA -->
  <meta name="theme-color" content="#ffffff" />
  <link rel="apple-touch-icon" href="img/icon.png" />

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta property="og:title" content="Nostr Spreadsheets">
  <meta property="og:description" content="The first Nostr-native spreadsheet">
  <meta property="og:image" content="https://sheetstr.amethyst.social/img/sheetstr-card-wide.png">
  <!-- Replace with the URL of your larger image -->
  <meta property="og:url" content="https://sheetstr.amethyst.social">

  <script src="https://unpkg.com/@univerjs/umd/lib/univer.full.umd.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@univerjs/umd/lib/univer.css">

  <script src="https://bundle.run/buffer@6.0.3"></script>
  <script src="https://bundle.run/bech32@2.0.0"></script>

  <script src="https://unpkg.com/nostr-tools/lib/nostr.bundle.js"></script>

  <script src="js/jquery-3.6.2.min.js"></script>
  <script src="js/nostr-sign.js"></script>
  <script src="js/nostr-filter.js"></script>
  <script src="js/nostr-sheetstr.js"></script>
  <script src="js/univer-utils.js"></script>

  <script src="https://www.unpkg.com/nostr-login@latest/dist/unpkg.js" data-perms="sign_event:35337,nip44_encrypt,nip44_decrypt"></script> 
</head>

<body>
  <div id="dashboard">
    <header id="header" class="center">
      <h1>Your Public Spreadsheets</h1>
    </header>
    <table class="styled-table">
      <thead>
          <tr>
              <th style="width: 45%;">Name</th>
              <th>By</th>
              <th>Team</th>
              <th class="right">Last Modified</th>
              <th class="center">Actions</th>
          </tr>
      </thead>
      <tbody id="sheets">
          
      </tbody>
    </table>

    <div style="display: inline-block">
      <input type="text" style="float: left; margin-right: 5px;" class="cool-field" id="newDTag" name="newDTag" value="" placeholder="My cool new sheet">
      <button id="create-button" onclick="document.location.href='?id=' + $('#newDTag').val(); return false;">Create</button>
    </div>
  </div>
  <div id="app-container">
    <header id="mini-header">
      <h2 id="sheet-name">Your Public Spreadsheets</h2>
      <p>Shared with: <span id="shares"></span>      
        <input type="text" style="margin-right:3px;" class="cool-field" id="newPubkey" name="newPubkey" value="" placeholder="Add npub">
        <button id="create-button" style="margin-bottom: 1px;" onclick="addNewShare()">Share</button>
      </p>
    </header>
    <div id="app"></div>
  </div>


  <script>
    var univer = undefined
    var univerAPI = undefined
    var loggedIn = false
    var initialized = false

    var expandedEvents = new Map()
    var userNames = new Map()
    var sharingWith = new Set()

    document.addEventListener('nlAuth', (e) => {
      initialized = true
      console.log("nlauth", e)
      if (e.detail.type === 'login' || e.detail.type === 'signup') {
        if (!loggedIn) {
          console.log("Logging In")
          loggedIn = true
          setTimeout(function() {
            loadUser()
          }, 200);
        }
      } else {
        if (loggedIn) {
          console.log("Logging Off")
          loggedIn = false
          setTimeout(function() {
            logOff()
          }, 200);
        }
      }
    });

    $(document).ready(function() {
      showDashboard()

      const authorParam = new URLSearchParams(window.location.search).get('author')

      if (authorParam && authorParam.length == 64) {
        loadUser()
      } else {
        setTimeout(function() {
          if (!initialized)
            document.dispatchEvent(new CustomEvent('nlLaunch', { detail: 'welcome' }));
        }, 500);
      }
    });

    function logOff() {
      $("#sheets").html("");
      showDashboard()
      loggedIn = false
      if (tentatives) {
        tentatives = 1000
      }
      if (ws) {
        ws.close()
      }
    }

    function loadUser() {
      const urlParams = new URLSearchParams(window.location.search);
      const authorParam = urlParams.get('author')

      console.log("loadUser")
      if (authorParam) {
        loggedIn = true
        loadPage(authorParam)
      } else if (window.nostr) {
        window.nostr.getPublicKey().then(function (pubkey) {
          if (pubkey) {
            loggedIn = true
            loadPage(pubkey)
          } else {
            logOff()
          }
        }).catch((err) => {
          console.log("LoadUser Err", err);
          logOff()
        })
      }
    }

    function loadPage(author) {
      const urlParams = new URLSearchParams(window.location.search);
      const authorParam = urlParams.get('author')
      const dTag = urlParams.get('id')

      console.log("onLoad", author, dTag)
      
      if (dTag) {
        $("#sheet-name").html(dTag)
        hideDashboard()
        if (authorParam) {
          loadId(authorParam, dTag)
        } else {
          loadId(author, dTag)
        }
      } else {
        showDashboard()
        if (authorParam) {
          loadDashboard(authorParam)
        } else {
          loadDashboard(author)
        }
      }
    }

    async function hideDashboard() {
      $("#dashboard").hide();
      $("#app-container").show();
    }
    
    async function showDashboard() {
      $("#app-container").hide();
      $("#dashboard").show();
    }

    async function loadDashboard(author) {
      $("#sheets").html("");
      fetchAllSpreadsheets(author, (ee) => {
        console.log("Event Received", ee)

        let currentVersion = expandedEvents.get(ee.address)
        if (currentVersion) {
          if (ee.event.created_at > currentVersion.event.created_at) {
            console.log("New version of ", ee.address)
            expandedEvents.set(ee.address, ee)
            addOrReplaceSheetLine(ee)
          }
        } else {
          console.log("New Sheet", ee.address)
          expandedEvents.set(ee.address, ee)
          addOrReplaceSheetLine(ee)
        }
      }, (pubkey, metadata) => { 
        console.log("New Metatada", pubkey, metadata)
        userNames.set(pubkey, metadata)
        updatePubkeyObservables()
      })
    }

    function updatePubkeyObservables() {
      console.log("UpdatePubkeyObservables")
      $(".pubkey-observer").each(function () {
        let obj = $(this)
        obj.html(getNameOrShortenKey(obj.attr('id')))
      })
    }

    function pubkeyObserver(pubkey) {
      return "<a href=\"?author="+pubkey+"\" id='" + pubkey + "' class='pubkey-observer'>" + getNameOrShortenKey(pubkey) + "</a>"
    }

    function addOrReplaceSheetLine(ee) {
      let id = sha256Hex(ee.address)
      if ($(id).length) {
        $(id).remove();
      }

      let deleteButton = ""
      if (ee.canEdit) {
        deleteButton = "<button onclick=\"deleteEvent('"+ee.address+"');event.stopPropagation();\">Delete</button>"
      }

      $("#sheets").append(
        "<tr id='"+ id +"' onclick=\"document.location.href='?author="+ee.event.pubkey+"&id="+ee.dTag+"'\">" +
          "<td>"+ee.title+"</td>" +
          "<td>"+pubkeyObserver(ee.event.pubkey)+"</td>" +
          "<td>"+ee.team.map(it => pubkeyObserver(it)).join("")+"</td>" +
          "<td class=\"right\">"+formatDate(ee.event.created_at)+"</td>" +
          "<td class=\"center\">"+deleteButton+"</td>"+
        "</tr>"
      )
    }

    function formatDate(unixtimestamp) {
      let date = new Date(unixtimestamp * 1000)
      return date.toLocaleString();
    }

    async function deleteEvent(address) {
      let event = events.get(address)
      if (event) {
        if (window.nostr) {
          await deleteSpreadSheet(event)
        }
        setTimeout(function() {
          loadUser()
        }, 500);
      }
    }

    function updateShares() {
      let component = $("#shares")
      component.html("")
      sharingWith.forEach((pubkey) => { 
        component.append(pubkeyObserver(pubkey) + "")
      })
    }

    function getNameOrShortenKey(pubkey) {
      if (userNames.has(pubkey)) {
        let metadata = userNames.get(pubkey)
        if (metadata.picture) {
          return "<img style=\"border-radius: 50%;\" width=\"30\" height=\"30\" src='" + metadata.picture + "'/>"
        } else if (metadata.display_name) {
          return metadata.display_name
        } else {
          return metadata.name
        }
      } else {
        return pubkey.substring(0, 2)
      } 
    }

    function shorten(str) {
      return str.substring(0, 6)+".."+str.substring(str.length-6, str.length)
    }

    function addNewShare() {
      const urlParams = new URLSearchParams(window.location.search);
      const author = urlParams.get('author')
      const dTag = urlParams.get('id')

      let newPubKey = npub2hex($("#newPubkey").val())
      sharingWith.add(newPubKey)
      updateShares()

      $("#newPubkey").val("")

      const activeWorkbook = univerAPI.getActiveWorkbook()
      const saveData = activeWorkbook.getSnapshot();

      try { 
        const data = convertUniverToDataArray(saveData)
        saveSpreadSheet(author, dTag, Array.from(sharingWith), data)
      } catch (e) {
        console.log(e)
      }
    }

    async function loadId(author, dTag) {
      sharingWith = new Set()

      fetchSpreadSheet(author, dTag, (name, shares, data) => { 
        var {
          UniverCore,
          UniverDesign,
          UniverEngineRender,
          UniverEngineFormula,
          UniverDocs,
          UniverDocsUi,
          UniverUi,
          UniverSheets,
          UniverSheetsUi,
          UniverSheetsNumfmt,
          UniverSheetsFormula,
          UniverFacade,
        } = window

        if (univer) {
          univer.dispose()
          univer = undefined
        }

        univer = new UniverCore.Univer({
          theme: UniverDesign.defaultTheme,
          locale: UniverCore.LocaleType.EN_US,
          locales: {
            [UniverCore.LocaleType.EN_US]: {
              ...UniverSheets.enUS,
              ...UniverDocsUi.enUS,
              ...UniverSheetsUi.enUS,
              ...UniverUi.enUS,
              ...UniverDesign.enUS,
            },
          },
        });

        univer.registerPlugin(UniverEngineRender.UniverRenderEnginePlugin);
        univer.registerPlugin(UniverEngineFormula.UniverFormulaEnginePlugin);

        univer.registerPlugin(UniverUi.UniverUIPlugin, {
          container: "app",
          header: true,
          footer: true,
        });

        univer.registerPlugin(UniverDocs.UniverDocsPlugin, {
          hasScroll: false,
        });
        univer.registerPlugin(UniverDocsUi.UniverDocsUIPlugin);

        univer.registerPlugin(UniverSheets.UniverSheetsPlugin);
        univer.registerPlugin(UniverSheetsUi.UniverSheetsUIPlugin);
        univer.registerPlugin(UniverSheetsNumfmt.UniverSheetsNumfmtPlugin);
        univer.registerPlugin(UniverSheetsFormula.UniverSheetsFormulaPlugin);    

        univerAPI = UniverFacade.FUniver.newAPI(univer)

        univerAPI.onCommandExecuted((command, options) => {
          // Only synchronize local mutations
          if (command.type !== 2 || options?.fromCollab || options?.onlyLocal || command.id === 'doc.mutation.rich-text-editing' || command.id === 'sheet.mutation.set-worksheet-row-auto-height') {
            return;
          }
          
          const activeWorkbook = univerAPI.getActiveWorkbook()
          const saveData = activeWorkbook.getSnapshot();

          try { 
            const data = convertUniverToDataArray(saveData)
            saveSpreadSheet(author, dTag, Array.from(sharingWith), data)
          } catch (e) {
            console.log(e)
          }
        })

        sharingWith = new Set()
        shares.forEach(item => sharingWith.add(item))
        updateShares()

        univer.createUniverSheet(convertDataArrayToUniver(name, data));
      }, (pubkey, metadata) => { 
        console.log("New Metatada", pubkey, metadata)
        userNames.set(pubkey, metadata)
        updatePubkeyObservables()
      })
    }
  </script>
</body>
</body>

</html>